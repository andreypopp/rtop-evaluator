(executable
  ((name evaluator)
   (public_name sketch_evaluator)
   (libraries (
           js_of_ocaml 
           js_of_ocaml-compiler 
           js_of_ocaml-toplevel 
           reason 
           compiler-libs
        ))
   (optional)
   (library_flags (-linkall))
   (preprocess (pps (js_of_ocaml-ppx)))
   (flags (:standard -rectypes))
  ))

#; (rule ((targets (evaluator.js))
#;        (action (run js_of_ocaml --toplevel --linkall --no-runtime
#;                ${lib:js_of_ocaml-compiler:runtime.js}
#;                ${lib:js_of_ocaml-compiler:toplevel.js}
#;                ${lib:js_of_ocaml-compiler:dynlink.js}
#;                --export ${path:stdlib.export} ${path:evaluator.bc} -I +stdlib/compiler-libs))))

(rule ((targets (stdlib.export))
       (action (run jsoo_listunits stdlib compiler-libs.common -o stdlib.export))))

(alias ((name DEFAULT)
        (deps (evaluator.js index.html))))

(rule ((targets (toplevel.js))
       (action (run jsoo_mktop 
                    -verbose
                    -jsopt "--disable shortvar --pretty"
                    -package str
                    -package unix
                    -jsopt +weak.js
                    -jsopt +toplevel.js
                    -jsopt +nat.js
                    -jsopt +dynlink.js
                    -jsopt "-I . --file ${path:evaluator.js}"
                #;     ${path:evaluator.bc}
                    -o toplevel.js
                    -I +stdlib/compiler-libs)
        )))

(rule ((targets (evaluator.js))
       (action (run js_of_ocaml ${path:evaluator.bc} --pretty))))
